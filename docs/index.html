<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Leaflet Map</title>

    <!-- import styling -->
    <link rel="stylesheet" href="css/leaflet.css"/>
    <link rel="stylesheet" href="css/custom.css"/>
    <!-- custom styling -->
    <style type="text/css">
      body{
        margin: 0;
        padding: 0;
      }
      #map {
        width: 100vw;
        height: 100vh;
      }
    </style>
  </head>
  <body>
    <!-- element that contains map -->
    <div id="map"></div>

    <!-- import packages -->
    <script src="js/leaflet.js"></script>

    <!-- load data -->
    <script src="data/axesofreconstruction_crs84.js"></script>
    <script src="data/featuretraces_crs84.js"></script>
    <script src="data/profileextents_crs84.js"></script>
    <script src="data/mapextents_crs84.js"></script>

    <!-- custom code for the leaflet map -->
    <script>
        // Map Object
        const map = L.map('map', {
            center: [36.85324009154614, 10.323104630306315],
            zoom: 18,
            zoomControl: true,
            maxZoom: 28,
            minZoom: 18
            });
        
        // Basemap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }).addTo(map);

        // Styles
        var highlightStyle = {
          weight: 5,
          color: '#666',
          fillOpacity: 0.7
        }
        var defaultStyle = {
          color: 'blue'
        }

        // Interaction
        function highlightFeature(e) {
          var layer = e.target;

          layer.setStyle(highlightStyle);

          // I'm not sure if this is necessary, but both GPT and
          // Stack Overflow (https://gis.stackexchange.com/q/227377)
          // suggested it
          if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            layer.bringToFront();
          }

          // Update the info control
          info.update(layer.feature.properties);
        }

        function onEachFeature(feature, layer, geoJsonLayer) {
          // Note the distinction between `layer` and `geoJsonLayer` - only the
          // former has the resetStyle() method
          layer.on({
            mouseover: highlightFeature,
            mouseout: function(e) {
              geoJsonLayer.resetStyle(e.target);
              info.update();
            }
          });
        }

        // Add Data to map
        function addGeoJsonLayer(geoJsonData, map) {
          // Create a container layer to add interactivity to
          var geoJsonLayer = L.geoJSON(geoJsonData, {
            style: function () {
              return { color: 'blue' }; // Default style
            }
          }).addTo(map);

          // Interactivity has to be added with explicit reference to container
          geoJsonLayer.eachLayer(function(layer) {
            onEachFeature(layer.feature, layer, geoJsonLayer);
          });

          return geoJsonLayer;
        }

        // When you add a new GeoJSON layer, get the layer instance
        var myGeoJsonLayer = addGeoJsonLayer(featureTraces, map);

        // Info control
        var info = L.control();

        info.onAdd = function (map) {
          this._div = L.DomUtil.create('div', 'info'); // create a div with the class "info"
          this.update();
          return this._div;
        }

        // Update info with new feature properties
        objectOrder = {
            'FeatureID': 1,
            'Constr': 2,
            'Period': 3,
            'Subperiod': 4,
            'Source': 5
        };

        function formatProperties (props, order) {
          // Re-order keys (need to copy order because it is used for checks below)
          const orderCopy = structuredClone(order)
          props = Object.assign(orderCopy, props)

          // Create formatted string - a table with a row for each property
          str = "<table>"
            for (let k of Object.keys(props)) {
              if (k in order) {
                row = "<tr><td><b>" + k + "</b></td><td>" + props[k] + "</td>"
                str = str + row
              }
            };
            str = str + "</table>"
            return str
        }

        info.update = function (props) {
          this._div.innerHTML = '<h4>Feature Info</h4>' + (props ?
              formatProperties(props, objectOrder)
              : 'Hover over a feature');
        };
        
        info.addTo(map)
    </script>
    </body>
</html>
